# E-Wallet Backend API

A secure e-wallet backend API built with FastAPI, featuring JWT authentication, OTP email verification, encrypted transaction notes, and comprehensive wallet operations.

## Features

- ğŸ” **Secure Authentication**
  - JWT-based access and refresh tokens
  - Email verification with OTP
  - Password hashing with bcrypt
  - Rate limiting on authentication endpoints

- ğŸ’° **Wallet Operations**
  - Deposit funds
  - Withdraw funds
  - Transfer to other users
  - Transaction history with encrypted notes

- ğŸ”’ **Security**
  - Environment-based configuration
  - Fernet encryption for transaction notes
  - Rate limiting to prevent abuse
  - SQL injection protection via SQLAlchemy ORM

- ğŸ“§ **Email Integration**
  - OTP delivery via SMTP
  - Professional HTML email templates
  - Configurable email service

## Tech Stack

- **Framework**: FastAPI
- **Database**: SQLite (configurable to PostgreSQL)
- **ORM**: SQLAlchemy
- **Migrations**: Alembic
- **Authentication**: python-jose (JWT)
- **Encryption**: cryptography (Fernet)
- **Email**: SMTP
- **Rate Limiting**: slowapi

## Installation

### Prerequisites

- Python 3.8+
- pip

### Setup Steps

1. **Clone the repository** (if applicable)
   ```bash
   cd /path/to/e-wallet/backend
   ```

2. **Create virtual environment**
   ```bash
   python3 -m venv .venv
   source .venv/bin/activate  # On Windows: .venv\Scripts\activate
   ```

3. **Install dependencies**
   ```bash
   pip install -r requirements.txt
   ```

4. **Run setup script to generate encryption keys**
   ```bash
   python setup.py
   ```
   This will create a `.env` file with secure, randomly generated keys.

5. **Configure email (optional)**
   Edit `.env` and uncomment/configure the SMTP settings:
   ```env
   SMTP_HOST=smtp.gmail.com
   SMTP_PORT=587
   SMTP_USER=your-email@gmail.com
   SMTP_PASSWORD=your-app-password
   SMTP_FROM=your-email@gmail.com
   ```

6. **Run database migrations**
   ```bash
   .venv/bin/python -m alembic upgrade head
   ```

7. **Start the server**
   ```bash
   uvicorn app.main:app --reload
   ```

8. **Visit API documentation**
   - Swagger UI: http://localhost:8000/docs
   - ReDoc: http://localhost:8000/redoc

## API Endpoints

### Authentication

- `POST /api/v1/auth/register` - Register new user (sends OTP email)
- `POST /api/v1/auth/verify-otp` - Verify email with OTP code
- `POST /api/v1/auth/resend-otp` - Resend OTP if expired
- `POST /api/v1/auth/login` - Login with email and password (requires verified email)

### Wallet Operations

- `GET /api/v1/wallets/me` - Get current user's wallet
- `POST /api/v1/wallets/deposit` - Deposit funds
- `POST /api/v1/wallets/withdraw` - Withdraw funds
- `POST /api/v1/wallets/transfer` - Transfer to another user
- `GET /api/v1/wallets/transactions` - Get transaction history

## Usage Example

### 1. Register a new user

```bash
curl -X POST "http://localhost:8000/api/v1/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "securepassword",
    "full_name": "John Doe"
  }'
```

### 2. Verify email with OTP

Check your email for the OTP code, then:

```bash
curl -X POST "http://localhost:8000/api/v1/auth/verify-otp" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "otp_code": "123456"
  }'
```

### 3. Login

```bash
curl -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=user@example.com&password=securepassword"
```

Response:
```json
{
  "access_token": "eyJ...",
  "refresh_token": "eyJ...",
  "token_type": "bearer"
}
```

### 4. Use the access token

```bash
curl -X GET "http://localhost:8000/api/v1/wallets/me" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

## Testing

### Automated Testing

Run the verification script to test all wallet operations:

```bash
.venv/bin/python verify_wallet.py
```

This script will:
- Register two users
- Verify wallet creation
- Test deposit, withdraw, and transfer operations
- Verify transaction history
- Validate encrypted notes

### Manual Testing

Use the interactive API documentation at http://localhost:8000/docs to:
1. Register and verify users
2. Test wallet operations
3. View transaction history

## Configuration

All configuration is managed through environment variables in `.env`:

| Variable | Description | Default |
|----------|-------------|---------|
| `SECRET_KEY` | JWT signing key | Generated by setup.py |
| `ENCRYPTION_KEY` | Fernet encryption key | Generated by setup.py |
| `DATABASE_URL` | Database connection string | sqlite:///./sql_app.db |
| `ACCESS_TOKEN_EXPIRE_MINUTES` | JWT access token expiry | 30 |
| `REFRESH_TOKEN_EXPIRE_DAYS` | JWT refresh token expiry | 7 |
| `OTP_EXPIRY_MINUTES` | OTP code expiry time | 5 |
| `RATE_LIMIT_PER_MINUTE` | Global rate limit | 60 |
| `SMTP_*` | Email service configuration | Not configured |

## Development

### Project Structure

```
backend/
â”œâ”€â”€ alembic/              # Database migrations
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ endpoints/  # API route handlers
â”‚   â”‚       â””â”€â”€ api.py      # API router
â”‚   â”œâ”€â”€ core/              # Core functionality
â”‚   â”‚   â”œâ”€â”€ config.py      # Configuration
â”‚   â”‚   â”œâ”€â”€ database.py    # Database setup
â”‚   â”‚   â”œâ”€â”€ encryption.py  # Encryption service
â”‚   â”‚   â”œâ”€â”€ rate_limit.py  # Rate limiting
â”‚   â”‚   â””â”€â”€ security.py    # Auth & JWT
â”‚   â”œâ”€â”€ models/            # SQLAlchemy models
â”‚   â”œâ”€â”€ schemas/           # Pydantic schemas
â”‚   â”œâ”€â”€ services/          # Business logic
â”‚   â”‚   â”œâ”€â”€ email_service.py
â”‚   â”‚   â””â”€â”€ otp.py
â”‚   â””â”€â”€ main.py           # FastAPI app
â”œâ”€â”€ .env                  # Environment variables (not in git)
â”œâ”€â”€ .env.example          # Environment template
â”œâ”€â”€ requirements.txt      # Python dependencies
â”œâ”€â”€ setup.py             # Setup script
â””â”€â”€ verify_wallet.py     # Test script
```

### Database Migrations

Create a new migration:
```bash
.venv/bin/python -m alembic revision -m "description"
```

Apply migrations:
```bash
.venv/bin/python -m alembic upgrade head
```

Rollback migration:
```bash
.venv/bin/python -m alembic downgrade -1
```

## Security Considerations

âš ï¸ **Important Security Notes:**

1. **Never commit `.env` file** - It contains sensitive keys
2. **Change default keys in production** - Use `setup.py` to generate new keys
3. **Use HTTPS in production** - Never send tokens over HTTP
4. **Configure CORS properly** - Set specific allowed origins in production
5. **Use PostgreSQL in production** - SQLite is for development only
6. **Enable email verification** - Configure SMTP settings
7. **Monitor rate limits** - Adjust based on your needs
8. **Regular backups** - Backup your database regularly
9. **Keep dependencies updated** - Run `pip list --outdated` regularly

## Troubleshooting

### Email not sending

**Issue**: OTP emails are not being received

**Solution**: 
1. Check `.env` SMTP configuration
2. For Gmail, use an App Password (not your regular password)
3. Check console output - OTP is printed when email service fails
4. Verify SMTP server allows connections from your IP

### Migration errors

**Issue**: Database migration fails

**Solution**:
```bash
# Reset database (development only - THIS DELETES ALL DATA)
rm sql_app.db
.venv/bin/python -m alembic upgrade head
```

### Rate limit errors

**Issue**: Getting 429 Too Many Requests

**Solution**:
- Wait a minute before retrying
- Adjust `RATE_LIMIT_PER_MINUTE` in `.env`
- Disable rate limiting temporarily: `RATE_LIMIT_ENABLED=false`

## Production Deployment

For production deployment:

1. **Use PostgreSQL**:
   ```env
   DATABASE_URL=postgresql://user:password@localhost/ewallet
   ```

2. **Use a production server**:
   ```bash
   pip install gunicorn
   gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker
   ```

3. **Set up HTTPS** with nginx or similar

4. **Configure proper CORS origins**

5. **Set up monitoring and logging**

6. **Use a proper secrets manager** (AWS Secrets Manager, HashiCorp Vault, etc.)

## Generate Dummy Data

To populate the database with dummy data for testing:

```bash
cd backend
source .venv/bin/activate  # On Windows: .venv\Scripts\activate
python generate_dummy_data.py
```

This script will:
- Create multiple users with Vietnamese names
- Create wallets with random balances
- Generate transaction history (deposits, withdrawals, transfers) over a period of time
- All users have password: `password123`
- All users are verified and ready to login

**Options:**
- Number of users (default: 15)
- Number of days of transaction history (default: 30)
- Option to delete existing data or keep it

**Example output:**
```
ğŸš€ E-Wallet Dummy Data Generator
============================================================
Creating 15 dummy users...
  âœ“ Created user: Nguyá»…n An (user1_an_nguyen@example.com) - Balance: 1,234,567â‚«
  ...

Creating transactions for the past 30 days...
  âœ“ Created 450 transactions

ğŸ“Š Wallet Balance Summary:
  Nguyá»…n An: 2,345,678â‚«
  ...
```

## License

[Your License Here]

## Support

For issues and questions, please [open an issue](link-to-issues) or contact the development team.
